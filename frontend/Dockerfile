FROM node:20-alpine AS development-dependencies-env
COPY . /app
WORKDIR /app
RUN npm ci

FROM node:20-alpine AS production-dependencies-env
COPY ./package.json package-lock.json /app/
WORKDIR /app
RUN npm ci --omit=dev

FROM node:20-alpine AS build-env
COPY . /app/
COPY --from=development-dependencies-env /app/node_modules /app/node_modules
WORKDIR /app

# Accept build arguments
ARG VITE_API_BASE_URL=http://localhost:8025
ARG VITE_API_TIMEOUT=30000
ARG VITE_API_RETRY_ATTEMPTS=3
ARG VITE_API_RETRY_DELAY=1000
ARG VITE_WS_BASE_URL=ws://localhost:8025
ARG VITE_WS_RECONNECT_ATTEMPTS=5
ARG VITE_WS_RECONNECT_DELAY=2000
ARG VITE_WS_HEARTBEAT_INTERVAL=30000
ARG VITE_WS_CONNECTION_TIMEOUT=10000
ARG VITE_AUTH_TOKEN_STORAGE_KEY=authToken
ARG VITE_AUTH_USER_STORAGE_KEY=authUser
ARG VITE_AUTH_TOKEN_EXPIRY_BUFFER=300000
ARG VITE_UI_THEME=light
ARG VITE_UI_LANGUAGE=en
ARG VITE_UI_AUTO_SAVE=true
ARG VITE_UI_AUTO_SAVE_INTERVAL=30000
ARG VITE_FEATURES_DEBUG_MODE=false
ARG VITE_FEATURES_ANALYTICS_ENABLED=false
ARG VITE_FEATURES_OFFLINE_MODE=false
ARG VITE_FEATURES_PUSH_NOTIFICATIONS=false
ARG VITE_DEV_HOT_RELOAD=false
ARG VITE_DEV_SOURCE_MAPS=false
ARG VITE_DEV_CONSOLE_LOGGING=false
ARG NODE_ENV=production
ARG VITE_APP_ENV=production

# Set environment variables from build arguments
ENV VITE_API_BASE_URL=$VITE_API_BASE_URL
ENV VITE_API_TIMEOUT=$VITE_API_TIMEOUT
ENV VITE_API_RETRY_ATTEMPTS=$VITE_API_RETRY_ATTEMPTS
ENV VITE_API_RETRY_DELAY=$VITE_API_RETRY_DELAY
ENV VITE_WS_BASE_URL=$VITE_WS_BASE_URL
ENV VITE_WS_RECONNECT_ATTEMPTS=$VITE_WS_RECONNECT_ATTEMPTS
ENV VITE_WS_RECONNECT_DELAY=$VITE_WS_RECONNECT_DELAY
ENV VITE_WS_HEARTBEAT_INTERVAL=$VITE_WS_HEARTBEAT_INTERVAL
ENV VITE_WS_CONNECTION_TIMEOUT=$VITE_WS_CONNECTION_TIMEOUT
ENV VITE_AUTH_TOKEN_STORAGE_KEY=$VITE_AUTH_TOKEN_STORAGE_KEY
ENV VITE_AUTH_USER_STORAGE_KEY=$VITE_AUTH_USER_STORAGE_KEY
ENV VITE_AUTH_TOKEN_EXPIRY_BUFFER=$VITE_AUTH_TOKEN_EXPIRY_BUFFER
ENV VITE_UI_THEME=$VITE_UI_THEME
ENV VITE_UI_LANGUAGE=$VITE_UI_LANGUAGE
ENV VITE_UI_AUTO_SAVE=$VITE_UI_AUTO_SAVE
ENV VITE_UI_AUTO_SAVE_INTERVAL=$VITE_UI_AUTO_SAVE_INTERVAL
ENV VITE_FEATURES_DEBUG_MODE=$VITE_FEATURES_DEBUG_MODE
ENV VITE_FEATURES_ANALYTICS_ENABLED=$VITE_FEATURES_ANALYTICS_ENABLED
ENV VITE_FEATURES_OFFLINE_MODE=$VITE_FEATURES_OFFLINE_MODE
ENV VITE_FEATURES_PUSH_NOTIFICATIONS=$VITE_FEATURES_PUSH_NOTIFICATIONS
ENV VITE_DEV_HOT_RELOAD=$VITE_DEV_HOT_RELOAD
ENV VITE_DEV_SOURCE_MAPS=$VITE_DEV_SOURCE_MAPS
ENV VITE_DEV_CONSOLE_LOGGING=$VITE_DEV_CONSOLE_LOGGING
ENV NODE_ENV=$NODE_ENV
ENV VITE_APP_ENV=$VITE_APP_ENV

RUN npm run build

FROM node:20-alpine
COPY ./package.json package-lock.json /app/
COPY --from=production-dependencies-env /app/node_modules /app/node_modules
COPY --from=build-env /app/build /app/build
WORKDIR /app

# Set runtime environment variables
ENV PORT=8026

# Expose the port the app runs on
EXPOSE 8026

CMD ["npm", "run", "start"]